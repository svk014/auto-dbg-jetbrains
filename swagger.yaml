openapi: 3.0.3
info:
  title: JetBrains Debugger API
  description: REST API for accessing JetBrains IDE debugger functionality
  version: 0.2.0
  contact:
    name: Auto DBG JetBrains Plugin
    url: https://github.com/svk014/auto-dbg-jetbrains

servers:
  - url: http://localhost:{port}
    description: Local development server
    variables:
      port:
        default: '<add port here>'
        description: Dynamic port assigned by the plugin

paths:
  /api/debugger/frame/{depth}:
    get:
      summary: Get frame information at specific depth
      description: Retrieves frame information from the call stack at the specified depth
      operationId: getFrame
      tags:
        - Frame Operations
      parameters:
        - name: depth
          in: path
          required: true
          description: The depth of the frame in the call stack (0 = current frame)
          schema:
            type: integer
            minimum: 0
            example: 0
      responses:
        '200':
          description: Frame information retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                success:
                  summary: Successful frame retrieval
                  value:
                    success: true
                    data:
                      methodName: "calculateSum"
                      lineNumber: 42
                      filePath: "/src/main/java/com/example/Calculator.java"
                    error: null
                    timestamp: 1722556800000
                no_frame:
                  summary: No frame at depth
                  value:
                    success: false
                    data: null
                    error: "No frame available at depth 5"
                    timestamp: 1722556800000
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /api/debugger/variables/{frameIndex}:
    get:
      summary: Get variables for a specific frame
      description: Retrieves all variables visible in the specified frame
      operationId: getVariables
      tags:
        - Variable Operations
      parameters:
        - name: frameIndex
          in: path
          required: true
          description: The index of the frame to get variables from
          schema:
            type: integer
            minimum: 0
            example: 0
      responses:
        '200':
          description: Variables retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                success:
                  summary: Successful variable retrieval
                  value:
                    success: true
                    data: {}
                    error: null
                    timestamp: 1722556800000
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /api/debugger/evaluate:
    post:
      summary: Evaluate an expression
      description: Evaluates a code expression in the context of the specified frame
      operationId: evaluateExpression
      tags:
        - Expression Operations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                expression:
                  type: string
                  description: The expression to evaluate
                  example: "count + 1"
                frameIndex:
                  type: integer
                  description: The frame index in which to evaluate the expression
                  default: 0
                  example: 0
      responses:
        '200':
          description: Expression evaluated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                success:
                  summary: Successful evaluation
                  value:
                    success: true
                    data:
                      result: 42
                      expression: "count + 1"
                    error: null
                    timestamp: 1722556800000
        '400':
          description: Bad request - invalid expression
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /api/debugger/trace_breakpoint:
    post:
      summary: Automated Breakpoint Tracing for Program Analysis
      description: |
        **Advanced automated debugging tool for non-intrusive program analysis.**
        
        This API enables sophisticated debugging workflows by automatically:
        
        **Core Capabilities:**
        - Sets a temporary breakpoint at the specified file and line
        - Automatically captures program execution when the breakpoint is hit
        - Evaluates custom expressions in the context of each breakpoint hit
        - Collects structured execution traces across multiple hits
        - Manages breakpoint lifecycle (setup, monitoring, cleanup)
        
        **Automated Workflow:**
        1. Temporarily disables user breakpoints to prevent interference
        2. Sets a breakpoint at the target location
        3. Monitors program execution and waits for breakpoint hits
        4. Evaluates the provided expression each time the breakpoint triggers
        5. Collects trace data showing how values change over time
        6. Automatically removes the temporary breakpoint
        7. Restores user breakpoints to their original state
        
        **Use Cases for Automated Debugging:**
        - **Variable Tracking**: Monitor how variables change across loop iterations
        - **Condition Analysis**: Track when specific conditions become true/false
        - **Performance Profiling**: Count executions or measure timing
        - **Bug Reproduction**: Automatically collect data when certain code paths execute
        - **Regression Testing**: Verify consistent behavior across code changes
        - **AI-Assisted Debugging**: Gather systematic program state data for analysis
        
        **Non-Intrusive Design:**
        - Operates without modifying source code
        - Preserves existing debugging session state
        - Handles timeout scenarios gracefully
        - Provides structured output for programmatic analysis
        
        **Example Scenario:**
        To track how a counter variable changes in a loop, set the breakpoint inside the loop
        and use expression "counter + index" to see the progression across iterations.
      operationId: traceBreakpoint
      tags:
        - Breakpoint Operations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - file
                - line
                - expression
              properties:
                file:
                  type: string
                  description: The full file path where to set the breakpoint
                  example: "/Users/user1/Documents/personal/SomeJavaProject/src/main/java/com/example/Calculator.java"
                line:
                  type: integer
                  description: The line number where to set the breakpoint (1-based)
                  minimum: 1
                  example: 42
                breakpointType:
                  type: string
                  description: The type of breakpoint to set
                  default: "LINE"
                  example: "LINE"
                lambdaOrdinal:
                  type: integer
                  description: Optional lambda ordinal for breakpoints within lambda expressions
                  minimum: 0
                  example: 0
                expression:
                  type: string
                  description: |
                    The expression to evaluate at each breakpoint hit. Can access local variables,
                    method parameters, and object fields visible at the breakpoint location.
                    Examples: "count", "arr.length", "x + y", "user.getName()"
                  example: "count + 1"
                maxHits:
                  type: integer
                  description: Maximum number of breakpoint hits to trace before stopping
                  default: 10
                  minimum: 1
                  maximum: 100
                  example: 10
                timeoutMs:
                  type: integer
                  description: Timeout in milliseconds to wait for each breakpoint hit
                  default: 30000
                  minimum: 1000
                  maximum: 300000
                  example: 30000
      responses:
        '200':
          description: Trace completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                success:
                  summary: Trace completed
                  value:
                    success: true
                    data:
                      hits: 3
                      traces:
                        - hitNumber: 1
                          location: "/src/main/java/com/example/Calculator.java:42"
                          frameIndex: 0
                          expressionResult: 43
                        - hitNumber: 2
                          location: "/src/main/java/com/example/Calculator.java:42"
                          frameIndex: 0
                          expressionResult: 44
                        - hitNumber: 3
                          location: "/src/main/java/com/example/Calculator.java:42"
                          frameIndex: 0
                          expressionResult: 45
                      breakpointRemoved: true
                    error: null
        '400':
          description: Bad request - invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /api/debugger/state:
    get:
      summary: Get current debugger state
      description: Retrieves the current state of the debugger including connection status, session information, and current position if paused
      operationId: getDebuggerState
      tags:
        - Debugger State
      responses:
        '200':
          description: Debugger state retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
              examples:
                paused:
                  summary: Debugger paused at breakpoint
                  value:
                    success: true
                    data:
                      status: "PAUSED"
                      sessionName: "Main"
                      currentPosition:
                        methodName: "calculateSum"
                        lineNumber: 42
                        filePath: "/src/main/java/com/example/Calculator.java"
                        className: "com.example.Calculator"
                      isConnected: true
                      availableSessions: ["Main"]
                    error: null
                    timestamp: 1722556800000
                running:
                  summary: Debugger running
                  value:
                    success: true
                    data:
                      status: "RUNNING"
                      sessionName: "Main"
                      currentPosition: null
                      isConnected: true
                      availableSessions: ["Main"]
                    error: null
                    timestamp: 1722556800000
                not_connected:
                  summary: No debugger session connected
                  value:
                    success: true
                    data:
                      status: "NOT_CONNECTED"
                      sessionName: null
                      currentPosition: null
                      isConnected: false
                      availableSessions: ["Main", "Test Session"]
                    error: null
                    timestamp: 1722556800000
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

components:
  schemas:
    ApiResponse:
      type: object
      description: Generic API response wrapper
      required:
        - success
        - timestamp
      properties:
        success:
          type: boolean
          description: Indicates if the operation was successful
          example: true
        data:
          nullable: true
          description: The response data (null on error)
        error:
          type: string
          nullable: true
          description: Error message (null on success)
          example: null
        timestamp:
          type: integer
          format: int64
          description: Unix timestamp when the response was generated
          example: 1722556800000

    FrameResponse:
      allOf:
        - $ref: '#/components/schemas/ApiResponse'
        - type: object
          properties:
            data:
              nullable: true
              allOf:
                - $ref: '#/components/schemas/FrameInfo'

    VariablesResponse:
      allOf:
        - $ref: '#/components/schemas/ApiResponse'
        - type: object
          properties:
            data:
              nullable: true
              type: object
              additionalProperties: true
              description: Variable data as key-value pairs

    BreakpointInfo:
      type: object
      description: Information about a debugger breakpoint
      required:
        - success
        - filePath
        - lineNumber
        - message
      properties:
        success:
          type: boolean
          description: Whether the breakpoint operation was successful
          example: true
        filePath:
          type: string
          description: The file path of the breakpoint
          example: "/src/main/java/com/example/Calculator.java"
        lineNumber:
          type: integer
          minimum: 1
          description: The line number of the breakpoint
          example: 42
        condition:
          type: string
          nullable: true
          description: Optional condition for the breakpoint
          example: "count > 10"
        message:
          type: string
          description: Status message about the breakpoint operation
          example: "Breakpoint set successfully"

    FrameInfo:
      type: object
      description: Information about a stack frame
      required:
        - methodName
        - lineNumber
        - filePath
      properties:
        methodName:
          type: string
          description: Name of the method in this frame
          example: "calculateSum"
        lineNumber:
          type: integer
          description: Current line number in the frame
          example: 42
        filePath:
          type: string
          description: Full path to the source file
          example: "/src/main/java/com/example/Calculator.java"

    OperationResult:
      type: object
      description: Result of a generic operation
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          description: Whether the operation was successful
          example: true
        message:
          type: string
          description: Description of the operation result
          example: "Operation completed successfully"
        details:
          type: object
          additionalProperties:
            type: string
          description: Additional details about the operation
          example: {}

tags:
  - name: Frame Operations
    description: Operations related to stack frames
  - name: Variable Operations
    description: Operations for accessing variable values
  - name: Breakpoint Operations
    description: Operations for managing breakpoints
  - name: Expression Operations
    description: Operations for evaluating expressions
  - name: Debugger State
    description: Operations for retrieving the debugger's current state
